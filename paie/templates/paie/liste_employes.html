{% extends 'paie/base.html' %}

{% block title %}Liste des Employés - PayrollPro{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Title -->
    <div class="row">
        <div class="col-12">
            <h1 class="page-title">
                <i class="bi bi-people"></i> Gestion des Employés
            </h1>
            <p class="text-muted">Liste complète de vos employés actifs</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center">
                <div class="stats-number text-primary">{{ total_employes }}</div>
                <div class="stats-label">Employés Actifs</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center">
                <div class="stats-number text-success">{{ masse_salariale_totale|floatformat:0 }} DH</div>
                <div class="stats-label">Masse Salariale Totale</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center">
                <div class="stats-number text-info">{{ salaire_moyen|floatformat:0 }} DH</div>
                <div class="stats-label">Salaire Moyen</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center">
                <a href="/admin/paie/employe/add/" class="btn btn-primary btn-lg">
                    <i class="bi bi-person-plus"></i><br>
                    Nouvel Employé
                </a>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control" id="searchEmploye" 
                       placeholder="Rechercher par nom, prénom, matricule ou fonction...">
            </div>
        </div>
        <div class="col-md-4">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" 
                        id="filterDropdown" data-bs-toggle="dropdown">
                    <i class="bi bi-funnel"></i> Filtrer par fonction
                </button>
                <ul class="dropdown-menu w-100">
                    <li><a class="dropdown-item" href="#" onclick="filterByFunction('tous')">Tous les employés</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="filterByFunction('Technicien')">Techniciens</a></li>
                    <li><a class="dropdown-item" href="#" onclick="filterByFunction('Comptable')">Comptables</a></li>
                    <li><a class="dropdown-item" href="#" onclick="filterByFunction('Commercial')">Commerciaux</a></li>
                    <li><a class="dropdown-item" href="#" onclick="filterByFunction('Secrétaire')">Secrétaires</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="/admin/paie/employe/add/" class="btn btn-success">
                    <i class="bi bi-person-plus"></i> Ajouter un employé
                </a>
                <a href="#" class="btn btn-info">
                    <i class="bi bi-upload"></i> Importer Excel
                </a>
                <a href="#" class="btn btn-warning">
                    <i class="bi bi-download"></i> Exporter Excel
                </a>
                <a href="#" class="btn btn-primary">
                    <i class="bi bi-envelope"></i> Email groupe
                </a>
            </div>
        </div>
    </div>

    <!-- Employee Table -->
    <div class="row">
        <div class="col-12">
            <div class="table-responsive">
                <table class="table table-hover" id="employeTable">
                    <thead>
                        <tr>
                            <th>Matricule</th>
                            <th>Nom & Prénom</th>
                            <th>Fonction</th>
                            <th>Salaire de Base</th>
                            <th>Date d'embauche</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employe in employes %}
                            <tr data-fonction="{{ employe.fonction }}">
                                <td>
                                    <strong class="text-primary">{{ employe.matricule }}</strong>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ employe.nom_complet }}</strong>
                                        {% if employe.email %}
                                            <br><small class="text-muted">
                                                <i class="bi bi-envelope"></i> {{ employe.email }}
                                            </small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ employe.fonction }}</span>
                                </td>
                                <td>
                                    <strong>{{ employe.salaire_base|floatformat:0 }} DH</strong>
                                </td>
                                <td>
                                    {{ employe.date_embauche|date:"d/m/Y" }}
                                    <br><small class="text-muted">
                                        Embauché en {{ employe.date_embauche|date:"Y" }}
                                    </small>
                                </td>
                                <td>
                                    {% if employe.actif %}
                                        <span class="badge-status bg-success">
                                            <i class="bi bi-check-circle"></i> Actif
                                        </span>
                                    {% else %}
                                        <span class="badge-status bg-danger">
                                            <i class="bi bi-x-circle"></i> Inactif
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'paie:detail_employe' employe.id %}" 
                                           class="btn btn-outline-primary" title="Voir détails">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="/admin/paie/employe/{{ employe.id }}/change/" 
                                           class="btn btn-outline-warning" title="Modifier">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="#" class="btn btn-outline-info" 
                                           title="Bulletin de paie" onclick="voirBulletin({{ employe.id }})">
                                            <i class="bi bi-file-text"></i>
                                        </a>
                                        <a href="#" class="btn btn-outline-success" 
                                           title="Contacter" onclick="contacterEmploye('{{ employe.email }}')">
                                            <i class="bi bi-envelope"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> 
                                        Aucun employé trouvé. 
                                        <a href="/admin/paie/employe/add/" class="alert-link">
                                            Ajoutez le premier employé
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Informations supplémentaires -->
    {% if employes %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> 
                <strong>{{ total_employes }}</strong> employé(s) affiché(s) • 
                Masse salariale totale: <strong>{{ masse_salariale_totale|floatformat:0 }} DH</strong> • 
                Salaire moyen: <strong>{{ salaire_moyen|floatformat:0 }} DH</strong>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Recherche en temps réel
document.getElementById('searchEmploye').addEventListener('keyup', function() {
    let searchValue = this.value.toLowerCase();
    let rows = document.querySelectorAll('#employeTable tbody tr');
    
    rows.forEach(function(row) {
        let text = row.textContent.toLowerCase();
        if (text.includes(searchValue)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Filtrage par fonction
function filterByFunction(fonction) {
    let rows = document.querySelectorAll('#employeTable tbody tr');
    
    rows.forEach(function(row) {
        if (fonction === 'tous' || row.dataset.fonction === fonction) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Mettre à jour le texte du bouton
    document.getElementById('filterDropdown').innerHTML = 
        '<i class="bi bi-funnel"></i> ' + (fonction === 'tous' ? 'Tous les employés' : fonction + 's');
}

// Fonctions d'action
function voirBulletin(employeId) {
    alert('Bulletin de paie pour l\'employé ' + employeId + ' - Fonction à implémenter');
}

function contacterEmploye(email) {
    if (email) {
        window.location.href = 'mailto:' + email;
    } else {
        alert('Aucun email renseigné pour cet employé');
    }
}
</script>
{% endblock %}