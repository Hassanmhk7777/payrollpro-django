{% extends 'paie/base.html' %}

{% block title %}Gestion des Absences - PayrollPro{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Title -->
    <div class="row">
        <div class="col-12">
            <h1 class="page-title">
                <i class="bi bi-calendar-x"></i> Gestion des Absences
            </h1>
            {% if role_utilisateur == 'rh' %}
                <p class="text-muted">Interface de validation et suivi des absences</p>
            {% else %}
                <p class="text-muted">Demandez vos congés et consultez vos soldes</p>
            {% endif %}
        </div>
    </div>

    <!-- Messages -->
    {% if message %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success alert-custom">
                <i class="bi bi-check-circle"></i> {{ message }}
            </div>
        </div>
    </div>
    {% endif %}

    {% if erreur %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger alert-custom">
                <i class="bi bi-exclamation-triangle"></i> {{ erreur }}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Vue RH : Statistiques et demandes à valider -->
    {% if role_utilisateur == 'rh' %}
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center">
                <div class="stats-number text-warning">{{ absences_en_attente }}</div>
                <div class="stats-label">Demandes en Attente</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center">
                <div class="stats-number text-info">{{ absences_du_mois }}</div>
                <div class="stats-label">Absences ce Mois</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center">
                <a href="#" class="btn btn-primary btn-lg">
                    <i class="bi bi-calendar-event"></i><br>
                    Calendrier
                </a>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stats-card text-center">
                <a href="#" class="btn btn-success btn-lg">
                    <i class="bi bi-file-spreadsheet"></i><br>
                    Export
                </a>
            </div>
        </div>
    </div>

    <!-- Demandes en attente de validation -->
    {% if demandes_attente %}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="section-title">
                <i class="bi bi-clock"></i> Demandes à Valider ({{ absences_en_attente }})
            </h3>
            
            <!-- Actions en lot -->
            <div class="mb-3">
                <div class="btn-group" role="group">
                    <button class="btn btn-success btn-sm" onclick="validerSelectionLot('approuver')">
                        <i class="bi bi-check-all"></i> Approuver Sélection
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="validerSelectionLot('refuser')">
                        <i class="bi bi-x-lg"></i> Refuser Sélection
                    </button>
                    <button class="btn btn-info btn-sm" onclick="toggleSelection()">
                        <i class="bi bi-check-square"></i> Tout Sélectionner
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover" id="tableAbsences">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleAllCheckboxes()">
                            </th>
                            <th>Employé</th>
                            <th>Type</th>
                            <th>Période</th>
                            <th>Durée</th>
                            <th>Motif</th>
                            <th>Date Demande</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for absence in demandes_attente %}
                        <tr id="row-{{ absence.id }}">
                            <td>
                                <input type="checkbox" class="absence-checkbox" value="{{ absence.id }}">
                            </td>
                            <td>
                                <strong>{{ absence.employe.nom_complet }}</strong>
                                <br><small class="text-muted">{{ absence.employe.matricule }} - {{ absence.employe.fonction }}</small>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ absence.get_type_absence_display }}</span>
                            </td>
                            <td>
                                {{ absence.date_debut|date:"d/m/Y" }} 
                                <br><small class="text-muted">au {{ absence.date_fin|date:"d/m/Y" }}</small>
                            </td>
                            <td>
                                <strong>{{ absence.nombre_jours }} jour{{ absence.nombre_jours|pluralize }}</strong>
                            </td>
                            <td>{{ absence.motif|default:"Aucun motif" }}</td>
                            <td>{{ absence.date_creation|date:"d/m/Y H:i" }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-success" onclick="validerAbsenceRapide({{ absence.id }}, 'approuver')" title="Approuver">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="validerAbsenceRapide({{ absence.id }}, 'refuser')" title="Refuser">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                    <button class="btn btn-warning" onclick="voirDetailAbsence({{ absence.id }})" title="Détails">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Interface Employé ou Section commune -->
    <div class="row">
        <!-- Soldes et demande (côté gauche) -->
        <div class="col-lg-6">
            {% if employe_actuel %}
            <div class="stats-card">
                <h3 class="section-title">
                    <i class="bi bi-person-badge"></i> 
                    {% if role_utilisateur == 'rh' %}
                        Nouvelle Demande (Test - {{ employe_actuel.nom_complet }})
                    {% else %}
                        Ma Nouvelle Demande
                    {% endif %}
                </h3>
                
                <!-- Soldes disponibles -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="alert alert-info text-center">
                            <h5>{{ solde_conges_restant }}</h5>
                            <small>Congés Payés Restants</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-success text-center">
                            <h5>{{ solde_rtt }}</h5>
                            <small>RTT Disponibles</small>
                        </div>
                    </div>
                </div>
                
                <!-- Formulaire de demande -->
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="type_absence" class="form-label">Type d'absence :</label>
                            <select name="type_absence" id="type_absence" class="form-select" required>
                                <option value="">Sélectionnez...</option>
                                <option value="CONGE">Congé payé</option>
                                <option value="MALADIE">Congé maladie</option>
                                <option value="MATERNITE">Congé maternité</option>
                                <option value="RTT">RTT</option>
                                <option value="SANS_SOLDE">Congé sans solde</option>
                                <option value="AUTRE">Autre</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Période :</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="date" name="date_debut" class="form-control" required>
                                    <small class="text-muted">Du</small>
                                </div>
                                <div class="col-6">
                                    <input type="date" name="date_fin" class="form-control" required>
                                    <small class="text-muted">Au</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="motif" class="form-label">Motif (optionnel) :</label>
                        <textarea name="motif" id="motif" class="form-control" rows="2" 
                                  placeholder="Précisez le motif de votre demande..."></textarea>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-calendar-plus"></i> Demander cette Absence
                        </button>
                    </div>
                </form>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle"></i> Aucun employé trouvé</h5>
                <p>Veuillez d'abord ajouter des employés pour utiliser la gestion des absences.</p>
                <a href="/admin/paie/employe/add/" class="btn btn-primary">Ajouter un employé</a>
            </div>
            {% endif %}
        </div>
        
        <!-- Historique des demandes (côté droit) -->
        <div class="col-lg-6">
            {% if mes_absences %}
            <div class="stats-card">
                <h3 class="section-title">
                    <i class="bi bi-clock-history"></i> 
                    {% if role_utilisateur == 'rh' %}
                        Dernières Demandes ({{ employe_actuel.nom_complet }})
                    {% else %}
                        Mes Dernières Demandes
                    {% endif %}
                </h3>
                
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Période</th>
                                <th>Durée</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for absence in mes_absences %}
                            <tr>
                                <td>
                                    <span class="badge bg-secondary">{{ absence.get_type_absence_display }}</span>
                                </td>
                                <td>
                                    {{ absence.date_debut|date:"d/m" }} - {{ absence.date_fin|date:"d/m" }}
                                </td>
                                <td>{{ absence.nombre_jours }}j</td>
                                <td>
                                    {% if absence.statut == 'APPROUVE' %}
                                        <span class="badge bg-success">✓ Approuvé</span>
                                    {% elif absence.statut == 'REFUSE' %}
                                        <span class="badge bg-danger">✗ Refusé</span>
                                    {% else %}
                                        <span class="badge bg-warning">⏳ En attente</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="text-center mt-3">
                    <a href="#" class="btn btn-outline-primary">
                        <i class="bi bi-list"></i> Voir Toutes mes Absences
                    </a>
                </div>
            </div>
            {% else %}
            <div class="stats-card">
                <div class="text-center py-4">
                    <i class="bi bi-calendar-check" style="font-size: 3rem; color: #ccc;"></i>
                    <h5 class="mt-3">Aucune absence enregistrée</h5>
                    <p class="text-muted">Vos demandes d'absence apparaîtront ici</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="stats-card">
                <h3 class="section-title">
                    <i class="bi bi-lightning"></i> Actions Rapides
                </h3>
                
                <div class="row">
                    {% if role_utilisateur == 'rh' %}
                    <div class="col-md-3 mb-2">
                        <a href="#" class="btn btn-info w-100">
                            <i class="bi bi-calendar-event"></i> Calendrier Équipe
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="#" class="btn btn-warning w-100">
                            <i class="bi bi-file-spreadsheet"></i> Export Excel
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'paie:calcul_paie' %}" class="btn btn-success w-100">
                            <i class="bi bi-calculator"></i> Calcul Paie
                        </a>
                    </div>
                    {% endif %}
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'paie:accueil' %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-house"></i> Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let absencesSelectionnees = [];

// Calcul automatique du nombre de jours
document.addEventListener('DOMContentLoaded', function() {
    const dateDebut = document.querySelector('input[name="date_debut"]');
    const dateFin = document.querySelector('input[name="date_fin"]');
    
    function calculerJours() {
        if (dateDebut && dateDebut.value && dateFin && dateFin.value) {
            const debut = new Date(dateDebut.value);
            const fin = new Date(dateFin.value);
            const diffTime = Math.abs(fin - debut);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            console.log(`Durée: ${diffDays} jour(s)`);
        }
    }
    
    if (dateDebut && dateFin) {
        dateDebut.addEventListener('change', calculerJours);
        dateFin.addEventListener('change', calculerJours);
    }
    
    // Attacher les événements aux checkboxes
    const checkboxes = document.querySelectorAll('.absence-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedAbsences);
    });
});

// Gestion des checkboxes
function toggleAllCheckboxes() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.absence-checkbox');
    
    if (selectAll) {
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        updateSelectedAbsences();
    }
}

function updateSelectedAbsences() {
    const checkboxes = document.querySelectorAll('.absence-checkbox:checked');
    absencesSelectionnees = Array.from(checkboxes).map(cb => cb.value);
    console.log(`${absencesSelectionnees.length} absence(s) sélectionnée(s)`);
}

function toggleSelection() {
    const selectAll = document.getElementById('selectAll');
    if (selectAll) {
        selectAll.checked = !selectAll.checked;
        toggleAllCheckboxes();
    }
}

// Validation rapide d'une absence
function validerAbsenceRapide(absenceId, action) {
    if (!confirm(`Êtes-vous sûr de vouloir ${action} cette demande d'absence ?`)) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        alert('Erreur: Token CSRF manquant');
        return;
    }
    
    const formData = new FormData();
    formData.append('action', action);
    formData.append('note_rh', '');
    formData.append('csrfmiddlewaretoken', csrfToken.value);
    
    fetch(`/absences/${absenceId}/valider/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            const row = document.getElementById(`row-${absenceId}`);
            if (row) {
                row.style.transition = 'opacity 0.5s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 500);
            }
        } else {
            showNotification(data.error || 'Erreur lors de la validation', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur de communication avec le serveur', 'error');
    });
}

// Validation en lot
function validerSelectionLot(action) {
    updateSelectedAbsences();
    
    if (absencesSelectionnees.length === 0) {
        alert('Veuillez sélectionner au moins une absence');
        return;
    }
    
    const actionText = action === 'approuver' ? 'approuver' : 'refuser';
    if (!confirm(`Êtes-vous sûr de vouloir ${actionText} ${absencesSelectionnees.length} demande(s) d'absence ?`)) {
        return;
    }
    
    const note = prompt(`Note RH pour ce ${actionText} en lot (optionnelle) :`);
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        alert('Erreur: Token CSRF manquant');
        return;
    }
    
    const formData = new FormData();
    formData.append('action', action);
    formData.append('note_rh', note || '');
    formData.append('csrfmiddlewaretoken', csrfToken.value);
    
    absencesSelectionnees.forEach(id => {
        formData.append('absences_ids', id);
    });
    
    fetch('/absences/validation-lot/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            absencesSelectionnees.forEach(id => {
                const row = document.getElementById(`row-${id}`);
                if (row) {
                    row.style.transition = 'opacity 0.5s';
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 500);
                }
            });
            
            if (data.erreurs && data.erreurs.length > 0) {
                setTimeout(() => {
                    showNotification(`Erreurs: ${data.erreurs.join(', ')}`, 'warning');
                }, 1000);
            }
            
            const selectAll = document.getElementById('selectAll');
            if (selectAll) selectAll.checked = false;
            absencesSelectionnees = [];
        } else {
            showNotification(data.error || 'Erreur lors de la validation en lot', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur de communication avec le serveur', 'error');
    });
}

// Voir le détail d'une absence
function voirDetailAbsence(absenceId) {
    fetch(`/absences/${absenceId}/valider/`)
    .then(response => response.json())
    .then(data => {
        if (data.absence) {
            const absence = data.absence;
            showDetailModal(absence, absenceId);
        } else {
            showNotification('Erreur lors du chargement des détails', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur lors du chargement des détails', 'error');
    });
}

function showDetailModal(absence, absenceId) {
    const modalContent = `
        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Détail de la Demande</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Employé:</strong> ${absence.employe} (${absence.matricule})</p>
                        <p><strong>Type:</strong> ${absence.type}</p>
                        <p><strong>Période:</strong> Du ${absence.date_debut} au ${absence.date_fin}</p>
                        <p><strong>Durée:</strong> ${absence.nombre_jours} jour(s)</p>
                        <p><strong>Motif:</strong> ${absence.motif}</p>
                        <p><strong>Date de demande:</strong> ${absence.date_demande}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="validerDepuisModal(${absenceId}, 'approuver')">
                            <i class="bi bi-check"></i> Approuver
                        </button>
                        <button type="button" class="btn btn-danger" onclick="validerDepuisModal(${absenceId}, 'refuser')">
                            <i class="bi bi-x"></i> Refuser
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const oldModal = document.getElementById('detailModal');
    if (oldModal) oldModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();
}

function validerDepuisModal(absenceId, action) {
    const modal = bootstrap.Modal.getInstance(document.getElementById('detailModal'));
    if (modal) modal.hide();
    
    validerAbsenceRapide(absenceId, action);
}

// Fonction pour afficher les notifications
function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Validation des dates dans le formulaire
const form = document.querySelector('form');
if (form) {
    form.addEventListener('submit', function(e) {
        const dateDebut = document.querySelector('input[name="date_debut"]');
        const dateFin = document.querySelector('input[name="date_fin"]');
        
        if (dateDebut && dateFin && dateDebut.value && dateFin.value) {
            if (new Date(dateDebut.value) > new Date(dateFin.value)) {
                e.preventDefault();
                alert('La date de fin doit être après la date de début');
            }
        }
    });
}
</script>
{% endblock %}