{% extends 'paie/base.html' %}

{% block title %}Test Int√©gration Absences{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üî¨ Test d'Int√©gration : Absences ‚Üí Paie</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <form method="post">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label class="form-label">Employ√© √† tester</label>
                                    <select name="employe_id" class="form-select" required>
                                        <option value="">Choisir un employ√©...</option>
                                        {% for employe in employes %}
                                        <option value="{{ employe.id }}">{{ employe.matricule }} - {{ employe.nom_complet }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label">Mois</label>
                                        <select name="mois" class="form-select">
                                            <option value="1">Janvier</option>
                                            <option value="2">F√©vrier</option>
                                            <option value="3">Mars</option>
                                            <option value="4">Avril</option>
                                            <option value="5">Mai</option>
                                            <option value="6">Juin</option>
                                            <option value="7">Juillet</option>
                                            <option value="8">Ao√ªt</option>
                                            <option value="9">Septembre</option>
                                            <option value="10">Octobre</option>
                                            <option value="11">Novembre</option>
                                            <option value="12">D√©cembre</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Ann√©e</label>
                                        <input type="number" name="annee" class="form-control" value="2025" min="2024" max="2026">
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary mt-3">
                                    <i class="fas fa-calculator me-2"></i>Tester le Calcul
                                </button>
                            </form>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Comment tester ?</h6>
                                <ol class="small mb-0">
                                    <li>Cr√©ez une absence "Sans solde" pour un employ√©</li>
                                    <li>Validez-la (statut APPROUVE)</li>
                                    <li>S√©lectionnez cet employ√© ici</li>
                                    <li>V√©rifiez que l'absence impacte le calcul</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Affichage des erreurs -->
            {% if erreurs %}
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Erreurs d√©tect√©es</h6>
                <ul class="mb-0">
                    {% for erreur in erreurs %}
                    <li>Employ√© {{ erreur.employe_id }} : {{ erreur.erreur }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <!-- R√©sultats des tests -->
            {% for test in tests_effectues %}
            <div class="card mb-4">
                <div class="card-header bg-{% if test.impact_calcule %}success{% else %}warning{% endif %} text-white">
                    <h6 class="mb-0">
                        {% if test.impact_calcule %}
                        <i class="fas fa-check-circle me-2"></i>Test R√âUSSI
                        {% else %}
                        <i class="fas fa-info-circle me-2"></i>Aucun impact
                        {% endif %}
                        - {{ test.employe.nom_complet }} ({{ test.mois }}/{{ test.annee }})
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Informations employ√© -->
                        <div class="col-md-4">
                            <h6 class="text-primary">üë§ Employ√©</h6>
                            <p><strong>Nom :</strong> {{ test.employe.nom_complet }}<br>
                            <strong>Matricule :</strong> {{ test.employe.matricule }}<br>
                            <strong>Salaire base :</strong> {{ test.salaire_base }} DH</p>
                        </div>
                        
                        <!-- Absences trouv√©es -->
                        <div class="col-md-4">
                            <h6 class="text-primary">üìÖ Absences du Mois</h6>
                            {% if test.absences_trouvees %}
                                {% for absence in test.absences_trouvees %}
                                <div class="small mb-2 p-2 bg-light rounded">
                                    <strong>{{ absence.get_type_absence_display }}</strong><br>
                                    Du {{ absence.date_debut|date:"d/m/Y" }} au {{ absence.date_fin|date:"d/m/Y" }}<br>
                                    <span class="badge {% if absence.impact_salaire %}bg-danger{% else %}bg-success{% endif %}">
                                        {% if absence.impact_salaire %}D√©duit du salaire{% else %}Pay√©{% endif %}
                                    </span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted small">Aucune absence trouv√©e</p>
                            {% endif %}
                        </div>
                        
                        <!-- Impact calcul√© -->
                        <div class="col-md-4">
                            <h6 class="text-primary">üí∞ Impact Calcul√©</h6>
                            <div class="small">
                                <strong>Jours d√©duits :</strong> {{ test.absences_info.jours_deduits }}<br>
                                <strong>Montant d√©duit :</strong> 
                                <span class="{% if test.absences_info.deduction_montant > 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ test.absences_info.deduction_montant }} DH
                                </span><br>
                                <strong>Salaire journalier :</strong> {{ test.absences_info.salaire_journalier }} DH
                            </div>
                        </div>
                    </div>
                    
                    <!-- D√©tails du bulletin -->
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">üíπ Calcul Final</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>Salaire de base :</td>
                                    <td class="text-end">{{ test.bulletin_data.salaire_base }} DH</td>
                                </tr>
                                <tr>
                                    <td>Primes :</td>
                                    <td class="text-end">{{ test.bulletin_data.total_primes }} DH</td>
                                </tr>
                                <tr class="table-danger">
                                    <td><strong>D√©duction absences :</strong></td>
                                    <td class="text-end"><strong>-{{ test.bulletin_data.deduction_absences }} DH</strong></td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>Salaire brut imposable :</strong></td>
                                    <td class="text-end"><strong>{{ test.bulletin_data.salaire_brut_imposable }} DH</strong></td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-info">üìä D√©ductions</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>CNSS (4.48%) :</td>
                                    <td class="text-end">{{ test.bulletin_data.cotisation_cnss }} DH</td>
                                </tr>
                                <tr>
                                    <td>AMO (2.26%) :</td>
                                    <td class="text-end">{{ test.bulletin_data.cotisation_amo }} DH</td>
                                </tr>
                                <tr>
                                    <td>CIMR (6%) :</td>
                                    <td class="text-end">{{ test.bulletin_data.cotisation_cimr }} DH</td>
                                </tr>
                                <tr>
                                    <td>IR :</td>
                                    <td class="text-end">{{ test.bulletin_data.impot_revenu }} DH</td>
                                </tr>
                                <tr class="table-success">
                                    <td><strong>Net √† payer :</strong></td>
                                    <td class="text-end"><strong>{{ test.bulletin_data.net_a_payer }} DH</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- D√©tails des absences si pr√©sentes -->
                    {% if test.absences_info.absences_details %}
                    <div class="mt-3">
                        <h6 class="text-warning"><i class="fas fa-list-ul me-2"></i>D√©tail des Absences</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Du</th>
                                        <th>Au</th>
                                        <th>Jours</th>
                                        <th>Motif</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for detail in test.absences_info.absences_details %}
                                    <tr>
                                        <td>{{ detail.type }}</td>
                                        <td>{{ detail.debut|date:"d/m/Y" }}</td>
                                        <td>{{ detail.fin|date:"d/m/Y" }}</td>
                                        <td><span class="badge bg-warning">{{ detail.jours }}</span></td>
                                        <td class="small">{{ detail.motif|default:"‚Äî" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            
            <!-- Guide de test -->
            {% if not tests_effectues %}
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>Comment tester l'int√©gration ?</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">üõ†Ô∏è √âtapes du Test</h6>
                            <ol>
                                <li><strong>Cr√©er une absence :</strong>
                                    <ul class="small">
                                        <li>Aller dans Gestion des Absences</li>
                                        <li>Cr√©er une absence "Sans solde" pour 2-3 jours</li>
                                        <li>La valider (statut APPROUVE)</li>
                                    </ul>
                                </li>
                                <li><strong>Tester le calcul :</strong>
                                    <ul class="small">
                                        <li>S√©lectionner l'employ√© ici</li>
                                        <li>Choisir le mois de l'absence</li>
                                        <li>Cliquer "Tester le Calcul"</li>
                                    </ul>
                                </li>
                                <li><strong>V√©rifier l'impact :</strong>
                                    <ul class="small">
                                        <li>Le montant d√©duit doit appara√Ætre</li>
                                        <li>Le salaire brut doit √™tre diminu√©</li>
                                        <li>Le net √† payer doit √™tre impact√©</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-success">‚úÖ R√©sultats Attendus</h6>
                            <div class="alert alert-light">
                                <p class="small mb-2"><strong>Pour un employ√© √† 5000 DH avec 3 jours d'absence sans solde :</strong></p>
                                <ul class="small mb-0">
                                    <li>Salaire journalier : 5000 √∑ 26 = 192.31 DH</li>
                                    <li>D√©duction : 192.31 √ó 3 = 576.93 DH</li>
                                    <li>Nouveau salaire brut : 5000 - 576.93 = 4423.07 DH</li>
                                    <li>Les cotisations sont recalcul√©es sur 4423.07 DH</li>
                                </ul>
                            </div>
                            
                            <div class="alert alert-warning">
                                <p class="small mb-0"><strong>‚ö†Ô∏è Types d'absences :</strong><br>
                                ‚Ä¢ <strong>Cong√© pay√© :</strong> Pas de d√©duction<br>
                                ‚Ä¢ <strong>Cong√© maladie :</strong> Pas de d√©duction<br>
                                ‚Ä¢ <strong>Sans solde :</strong> D√©duction du salaire</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <p class="text-muted small">
                            üí° Retournez √† votre interface principale pour g√©rer les absences et calculer la paie
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.table-sm td, .table-sm th {
    padding: 0.3rem;
}
.badge {
    font-size: 0.75em;
}
</style>
{% endblock %}