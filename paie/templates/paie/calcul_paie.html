{% extends 'paie/base.html' %}

{% block title %}Calcul de Paie - PayrollPro{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Title -->
    <div class="row">
        <div class="col-12">
            <h1 class="page-title">
                <i class="bi bi-calculator"></i> Calcul de la Paie Mensuelle
            </h1>
            <p class="text-muted">Système automatique de calcul selon la législation marocaine</p>
        </div>
    </div>

    <!-- Messages de résultat -->
    {% if message %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success alert-custom">
                <i class="bi bi-check-circle"></i> {{ message }}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Erreurs -->
    {% if erreurs %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning alert-custom">
                <h5><i class="bi bi-exclamation-triangle"></i> Erreurs détectées :</h5>
                {% for erreur in erreurs %}
                    <p class="mb-1">• {{ erreur.employe.nom_complet }} : {{ erreur.erreur }}</p>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Statistiques de calcul -->
    {% if statistiques %}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="section-title">
                <i class="bi bi-graph-up"></i> Résultats du Calcul - 
                {% if mois_traite == 1 %}Janvier
                {% elif mois_traite == 2 %}Février
                {% elif mois_traite == 3 %}Mars
                {% elif mois_traite == 4 %}Avril
                {% elif mois_traite == 5 %}Mai
                {% elif mois_traite == 6 %}Juin
                {% elif mois_traite == 7 %}Juillet
                {% elif mois_traite == 8 %}Août
                {% elif mois_traite == 9 %}Septembre
                {% elif mois_traite == 10 %}Octobre
                {% elif mois_traite == 11 %}Novembre
                {% elif mois_traite == 12 %}Décembre
                {% endif %} {{ annee_traitee }}
            </h3>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card text-center">
                <div class="stats-number text-primary">{{ statistiques.total_employes }}</div>
                <div class="stats-label">Employés Traités</div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card text-center">
                <div class="stats-number text-success">{{ statistiques.bulletins_generes }}</div>
                <div class="stats-label">Bulletins Générés</div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card text-center">
                <div class="stats-number text-info">{{ statistiques.masse_salariale_brute|floatformat:0 }} DH</div>
                <div class="stats-label">Masse Sal. Brute</div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card text-center">
                <div class="stats-number text-warning">{{ statistiques.total_cotisations|floatformat:0 }} DH</div>
                <div class="stats-label">Total Cotisations</div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card text-center">
                <div class="stats-number text-danger">{{ statistiques.total_ir|floatformat:0 }} DH</div>
                <div class="stats-label">Total IR</div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card text-center">
                <div class="stats-number text-success">{{ statistiques.masse_salariale_nette|floatformat:0 }} DH</div>
                <div class="stats-label">Net à Payer</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- NOUVEAU : Bouton Test d'Intégration Absences -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stats-card border-info">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-info mb-1">
                            <i class="bi bi-flask"></i> Test d'Intégration Absences → Paie
                        </h6>
                        <p class="small text-muted mb-0">
                            Vérifiez que les absences sans solde impactent correctement les calculs avant le traitement en lot.
                        </p>
                    </div>
                    <div>
                        <a href="/test-absences/" class="btn btn-outline-info">
                            <i class="bi bi-calculator"></i> Tester l'Intégration
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire de calcul -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="stats-card">
                <h3 class="section-title">
                    <i class="bi bi-gear"></i> Paramètres de Calcul
                </h3>
                
                <form method="post" id="calculForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-3">
                            <label for="mois" class="form-label">Mois :</label>
                            <select name="mois" id="mois" class="form-select" required>
                                <option value="1" {% if mois_actuel == 1 %}selected{% endif %}>Janvier</option>
                                <option value="2" {% if mois_actuel == 2 %}selected{% endif %}>Février</option>
                                <option value="3" {% if mois_actuel == 3 %}selected{% endif %}>Mars</option>
                                <option value="4" {% if mois_actuel == 4 %}selected{% endif %}>Avril</option>
                                <option value="5" {% if mois_actuel == 5 %}selected{% endif %}>Mai</option>
                                <option value="6" {% if mois_actuel == 6 %}selected{% endif %}>Juin</option>
                                <option value="7" {% if mois_actuel == 7 %}selected{% endif %}>Juillet</option>
                                <option value="8" {% if mois_actuel == 8 %}selected{% endif %}>Août</option>
                                <option value="9" {% if mois_actuel == 9 %}selected{% endif %}>Septembre</option>
                                <option value="10" {% if mois_actuel == 10 %}selected{% endif %}>Octobre</option>
                                <option value="11" {% if mois_actuel == 11 %}selected{% endif %}>Novembre</option>
                                <option value="12" {% if mois_actuel == 12 %}selected{% endif %}>Décembre</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="annee" class="form-label">Année :</label>
                            <select name="annee" id="annee" class="form-select" required>
                                <option value="2024" {% if annee_actuelle == 2024 %}selected{% endif %}>2024</option>
                                <option value="2025" {% if annee_actuelle == 2025 %}selected{% endif %}>2025</option>
                                <option value="2026" {% if annee_actuelle == 2026 %}selected{% endif %}>2026</option>
                            </select>
                        </div>
                        
                             <div class="col-md-6">
                            <label class="form-label">Actions :</label><br>
                            <div class="btn-group w-100" role="group">
                                <button type="submit" name="action" value="calculer" class="btn btn-success">
                                    <i class="bi bi-calculator"></i> Calculer Tout
                                </button>
                                <button type="button" class="btn btn-info" onclick="toggleEmployeSelection()">
                                    <i class="bi bi-people"></i> Sélectionner Employés
                                </button>
                                <button type="button" class="btn btn-warning" onclick="showPreview()">
                                    <i class="bi bi-eye"></i> Aperçu
                                </button>
                             <a href="{% url 'paie:export_bulletins_excel' %}" class="btn btn-outline-success">
                                    <i class="bi bi-file-excel"></i> Export Excel
                                </a>
                                <a href="{% url 'paie:page_export_cnss' %}" class="btn btn-warning">
                                    <i class="bi bi-file-spreadsheet"></i> Export CNSS
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Paramètres système -->
        <div class="col-lg-4">
            <div class="stats-card">
                <h3 class="section-title">
                    <i class="bi bi-sliders"></i> Paramètres Système
                </h3>
                
                <table class="table table-sm">
                    <tr>
                        <td>CNSS (salarié) :</td>
                        <td><strong>4.48%</strong></td>
                    </tr>
                    <tr>
                        <td>AMO (salarié) :</td>
                        <td><strong>2.26%</strong></td>
                    </tr>
                    <tr>
                        <td>CIMR :</td>
                        <td><strong>6.00%</strong></td>
                    </tr>
                    <tr>
                        <td>Frais prof. :</td>
                        <td><strong>20%</strong></td>
                    </tr>
                    <tr>
                        <td>Plafond CNSS :</td>
                        <td><strong>6,000 DH</strong></td>
                    </tr>
                </table>
                
                <a href="/admin/paie/parametrepaie/" class="btn btn-sm btn-outline-primary w-100">
                    <i class="bi bi-gear"></i> Modifier Paramètres
                </a>
            </div>
        </div>
    </div>

    <!-- Sélection des employés (masqué par défaut) -->
    <div class="row mb-4" id="employeSelection" style="display: none;">
        <div class="col-12">
            <div class="stats-card">
                <h3 class="section-title">
                    <i class="bi bi-check2-square"></i> Sélection des Employés
                </h3>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                            <i class="bi bi-check-all"></i> Tout sélectionner
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectNone()">
                            <i class="bi bi-square"></i> Tout désélectionner
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    {% for employe in employes %}
                        <div class="col-md-4 mb-2">
                            <div class="form-check">
                                <input class="form-check-input employe-checkbox" type="checkbox" 
                                       name="employes" value="{{ employe.id }}" id="emp{{ employe.id }}" checked>
                                <label class="form-check-label" for="emp{{ employe.id }}">
                                    <strong>{{ employe.matricule }}</strong> - {{ employe.nom_complet }}
                                    <br><small class="text-muted">{{ employe.fonction }} • {{ employe.salaire_base }} DH</small>
                                </label>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Aperçu du calcul -->
    {% if preview_bulletin %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="stats-card">
                <h3 class="section-title">
                    <i class="bi bi-file-text"></i> Aperçu du Bulletin - {{ preview_bulletin.employe.nom_complet }}
                </h3>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="text-primary">💰 Gains</h5>
                        <table class="table table-sm">
                            <tr>
                                <td>Salaire de base :</td>
                                <td class="text-end"><strong>{{ preview_bulletin.salaire_base|floatformat:2 }} DH</strong></td>
                            </tr>
                            {% if preview_bulletin.total_primes > 0 %}
                            <tr>
                                <td>Primes :</td>
                                <td class="text-end"><strong>{{ preview_bulletin.total_primes|floatformat:2 }} DH</strong></td>
                            </tr>
                            {% endif %}
                            {% if preview_bulletin.heures_sup > 0 %}
                            <tr>
                                <td>Heures supplémentaires :</td>
                                <td class="text-end"><strong>{{ preview_bulletin.heures_sup|floatformat:2 }} DH</strong></td>
                            </tr>
                            {% endif %}
                            <!-- NOUVEAU : Affichage déduction absences dans l'aperçu -->
                            {% if preview_bulletin.deduction_absences > 0 %}
                            <tr class="table-warning">
                                <td>Déduction absences :</td>
                                <td class="text-end"><strong class="text-danger">-{{ preview_bulletin.deduction_absences|floatformat:2 }} DH</strong></td>
                            </tr>
                            {% endif %}
                            <tr class="table-success">
                                <td><strong>Total Brut Imposable :</strong></td>
                                <td class="text-end"><strong>{{ preview_bulletin.salaire_brut_imposable|floatformat:2 }} DH</strong></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h5 class="text-danger">💸 Retenues</h5>
                        <table class="table table-sm">
                            <tr>
                                <td>CNSS (4.48%) :</td>
                                <td class="text-end"><strong>{{ preview_bulletin.cotisation_cnss|floatformat:2 }} DH</strong></td>
                            </tr>
                            <tr>
                                <td>AMO (2.26%) :</td>
                                <td class="text-end"><strong>{{ preview_bulletin.cotisation_amo|floatformat:2 }} DH</strong></td>
                            </tr>
                            <tr>
                                <td>CIMR (6%) :</td>
                                <td class="text-end"><strong>{{ preview_bulletin.cotisation_cimr|floatformat:2 }} DH</strong></td>
                            </tr>
                            <tr>
                                <td>Impôt sur le Revenu :</td>
                                <td class="text-end"><strong>{{ preview_bulletin.impot_revenu|floatformat:2 }} DH</strong></td>
                            </tr>
                            {% if preview_bulletin.total_retenues > 0 %}
                            <tr>
                                <td>Autres retenues :</td>
                                <td class="text-end"><strong>{{ preview_bulletin.total_retenues|floatformat:2 }} DH</strong></td>
                            </tr>
                            {% endif %}
                            {% if preview_bulletin.total_avances > 0 %}
                            <tr>
                                <td>Avances :</td>
                                <td class="text-end"><strong>{{ preview_bulletin.total_avances|floatformat:2 }} DH</strong></td>
                            </tr>
                            {% endif %}
                            <tr class="table-danger">
                                <td><strong>Total Retenues :</strong></td>
                                <td class="text-end"><strong>{{ preview_bulletin.total_deductions|floatformat:2 }} DH</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12 text-center">
                        <div class="alert alert-success">
                            <h4><i class="bi bi-cash"></i> NET À PAYER : <strong>{{ preview_bulletin.net_a_payer|floatformat:2 }} DH</strong></h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Bulletins existants -->
    {% if bulletins_existants %}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="section-title">
                <i class="bi bi-file-earmark-text"></i> Bulletins du Mois en Cours 
            </h3>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Employé</th>
                            <th>Salaire Brut</th>
                            <th>Cotisations</th>
                            <th>Impôt</th>
                            <th>Net à Payer</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bulletin in bulletins_existants %}
                            <tr>
                                <td>
                                    <strong>{{ bulletin.employe.nom_complet }}</strong>
                                    <br><small class="text-muted">{{ bulletin.employe.matricule }} - {{ bulletin.employe.fonction }}</small>
                                </td>
                                <td><strong>{{ bulletin.salaire_brut_imposable|floatformat:0 }} DH</strong></td>
                                <td>{{ bulletin.cotisation_cnss|add:bulletin.cotisation_amo|add:bulletin.cotisation_cimr|floatformat:0 }} DH</td>
                                <td>{{ bulletin.impot_revenu|floatformat:0 }} DH</td>
                                <td><strong class="text-success">{{ bulletin.net_a_payer|floatformat:0 }} DH</strong></td>
                                <td>
                                    {% if bulletin.valide %}
                                        {% if bulletin.envoye %}
                                            <span class="badge bg-success"><i class="bi bi-check-all"></i> Envoyé</span>
                                        {% else %}
                                            <span class="badge bg-info"><i class="bi bi-check"></i> Validé</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-warning"><i class="bi bi-clock"></i> En attente</span>
                                    {% endif %}
                                </td>
                             <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" title="Voir détails">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-success" title="Valider">
                                            <i class="bi bi-check"></i>
                                        </button>
                                        <a href="{% url 'paie:bulletin_pdf' bulletin.id %}" class="btn btn-outline-info" title="Télécharger PDF" target="_blank">
                                            <i class="bi bi-file-pdf"></i>
                                        </a>
                                        <a href="{% url 'paie:export_bulletin_excel' bulletin.id %}" class="btn btn-outline-success" title="Export Excel" target="_blank">
                                            <i class="bi bi-file-excel"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Message si pas d'employés -->
    {% if not employes %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info text-center">
                <h4><i class="bi bi-info-circle"></i> Aucun employé trouvé</h4>
                <p>Vous devez d'abord ajouter des employés pour pouvoir calculer la paie.</p>
                <a href="/admin/paie/employe/add/" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i> Ajouter un employé
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle de la sélection des employés
function toggleEmployeSelection() {
    const selection = document.getElementById('employeSelection');
    if (selection.style.display === 'none') {
        selection.style.display = 'block';
    } else {
        selection.style.display = 'none';
    }
}

// Sélectionner tous les employés
function selectAll() {
    const checkboxes = document.querySelectorAll('.employe-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

// Désélectionner tous les employés
function selectNone() {
    const checkboxes = document.querySelectorAll('.employe-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}

// Aperçu pour un employé
function showPreview() {
    const selectedEmployes = document.querySelectorAll('.employe-checkbox:checked');
    if (selectedEmployes.length === 0) {
        alert('Veuillez sélectionner au moins un employé pour l\'aperçu');
        return;
    }
    
    // Prendre le premier employé sélectionné pour l'aperçu
    const employeId = selectedEmployes[0].value;
    
    // Créer un formulaire temporaire pour l'aperçu
    const form = document.createElement('form');
    form.method = 'post';
    form.innerHTML = `
        <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
        <input type="hidden" name="action" value="preview">
        <input type="hidden" name="mois" value="${document.getElementById('mois').value}">
        <input type="hidden" name="annee" value="${document.getElementById('annee').value}">
        <input type="hidden" name="employe_preview" value="${employeId}">
    `;
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
