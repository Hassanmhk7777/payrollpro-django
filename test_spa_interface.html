<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test SPA Employ√©s - PayrollPro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .test-error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .test-info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .loading { text-align: center; margin: 20px 0; }
        #spa-content { min-height: 400px; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-vial text-primary me-2"></i>
                    Test SPA Employ√©s - PayrollPro
                </h1>
                
                <div class="alert alert-info">
                    <strong>Objectif :</strong> Tester le syst√®me SPA pour la gestion des employ√©s apr√®s les corrections appliqu√©es.
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-bars me-2"></i>Navigation Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="testSPAEmployees()">
                                <i class="fas fa-users me-2"></i>Tester SPA Employ√©s
                            </button>
                            <button class="btn btn-secondary" onclick="testDirectAPI()">
                                <i class="fas fa-api me-2"></i>Test API Direct
                            </button>
                            <button class="btn btn-info" onclick="clearResults()">
                                <i class="fas fa-trash me-2"></i>Vider les r√©sultats
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-info-circle me-2"></i>√âtat des Tests</h6>
                    </div>
                    <div class="card-body">
                        <div id="test-status">
                            <p class="text-muted">Aucun test lanc√©</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <!-- Zone de contenu SPA -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-desktop me-2"></i>Contenu SPA</h5>
                    </div>
                    <div class="card-body">
                        <div id="spa-content">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-mouse-pointer fa-3x mb-3"></i>
                                <p>Cliquez sur "Tester SPA Employ√©s" pour charger le contenu</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Zone de r√©sultats des tests -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-clipboard-list me-2"></i>R√©sultats des Tests</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <!-- Les r√©sultats des tests appara√Ætront ici -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Fonction pour ajouter un r√©sultat de test
        function addTestResult(type, message) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'} me-2"></i>${message}`;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // Fonction pour mettre √† jour le statut
        function updateStatus(message) {
            document.getElementById('test-status').innerHTML = `<p class="text-info">${message}</p>`;
        }

        // Test principal du SPA Employ√©s
        function testSPAEmployees() {
            addTestResult('info', 'D√©but du test SPA Employ√©s...');
            updateStatus('Test en cours...');
            
            // Vider le contenu SPA
            document.getElementById('spa-content').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Chargement...</p></div>';
            
            // Simuler loadSPAContent('employees')
            fetch('/api/spa/employees/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                addTestResult('info', `R√©ponse HTTP re√ßue - Status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    addTestResult('success', 'API SPA employ√©s r√©pond correctement');
                    
                    // Injecter le contenu dans la zone SPA
                    document.getElementById('spa-content').innerHTML = data.content;
                    
                    // V√©rifier que les √©l√©ments essentiels sont pr√©sents
                    const checks = [
                        { selector: '.employees-spa-section', name: 'Section SPA employ√©s' },
                        { selector: '#searchEmployees', name: 'Champ de recherche' },
                        { selector: '#siteFilter', name: 'Filtre par site' },
                        { selector: '#deptFilter', name: 'Filtre par d√©partement' },
                        { selector: '#employeesTable', name: 'Tableau des employ√©s' },
                        { selector: '#employeesTableBody', name: 'Corps du tableau' }
                    ];
                    
                    let allChecksPass = true;
                    checks.forEach(check => {
                        const element = document.querySelector(check.selector);
                        if (element) {
                            addTestResult('success', `‚úì ${check.name} trouv√©`);
                        } else {
                            addTestResult('error', `‚úó ${check.name} manquant`);
                            allChecksPass = false;
                        }
                    });
                    
                    // Tester les fonctions JavaScript
                    if (typeof filterEmployees === 'function') {
                        addTestResult('success', '‚úì Fonction filterEmployees disponible');
                        try {
                            filterEmployees();
                            addTestResult('success', '‚úì Fonction filterEmployees ex√©cut√©e avec succ√®s');
                        } catch (e) {
                            addTestResult('error', `‚úó Erreur lors de l'ex√©cution de filterEmployees: ${e.message}`);
                            allChecksPass = false;
                        }
                    } else {
                        addTestResult('error', '‚úó Fonction filterEmployees non disponible');
                        allChecksPass = false;
                    }
                    
                    // Compter les employ√©s affich√©s
                    const employeeRows = document.querySelectorAll('#employeesTableBody tr');
                    addTestResult('info', `${employeeRows.length} employ√©(s) affich√©(s) dans le tableau`);
                    
                    if (allChecksPass) {
                        addTestResult('success', 'üéâ TOUS LES TESTS PASSENT ! Le syst√®me SPA employ√©s fonctionne parfaitement.');
                        updateStatus('‚úÖ Tests r√©ussis');
                    } else {
                        addTestResult('error', '‚ö†Ô∏è Certains √©l√©ments sont manquants ou ne fonctionnent pas.');
                        updateStatus('‚ö†Ô∏è Tests partiellement r√©ussis');
                    }
                    
                } else {
                    addTestResult('error', `Erreur API: ${data.error || 'Erreur inconnue'}`);
                    document.getElementById('spa-content').innerHTML = `<div class="alert alert-danger">Erreur: ${data.error}</div>`;
                    updateStatus('‚ùå √âchec des tests');
                }
            })
            .catch(error => {
                addTestResult('error', `Erreur de connexion: ${error.message}`);
                document.getElementById('spa-content').innerHTML = `<div class="alert alert-danger">Erreur de connexion: ${error.message}</div>`;
                updateStatus('‚ùå Erreur de connexion');
            });
        }

        // Test direct de l'API sans interface
        function testDirectAPI() {
            addTestResult('info', 'Test direct de l\'API...');
            
            fetch('/api/spa/employees/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addTestResult('success', 'API r√©pond correctement');
                    const contentLength = data.content ? data.content.length : 0;
                    addTestResult('info', `Longueur du contenu HTML: ${contentLength} caract√®res`);
                    
                    // Analyser le contenu
                    if (data.content.includes('Gestion des Employ√©s')) {
                        addTestResult('success', '‚úì Titre principal trouv√©');
                    }
                    if (data.content.includes('employees-spa-section')) {
                        addTestResult('success', '‚úì Section SPA correctement format√©e');
                    }
                    if (data.content.includes('filterEmployees')) {
                        addTestResult('success', '‚úì Fonction JavaScript de filtrage pr√©sente');
                    }
                } else {
                    addTestResult('error', `Erreur API: ${data.error}`);
                }
            })
            .catch(error => {
                addTestResult('error', `Erreur: ${error.message}`);
            });
        }

        // Vider les r√©sultats
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-status').innerHTML = '<p class="text-muted">Aucun test lanc√©</p>';
        }

        // Auto-test au chargement de la page
        window.addEventListener('load', function() {
            addTestResult('info', 'Page de test charg√©e - Pr√™t pour les tests');
        });
    </script>
</body>
</html>
